<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TMotorCANControl.servo_serial &mdash; TMotorCANControl 1.2.3 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TMotorCANControl
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TMotorCANControl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">TMotorCANControl.servo_serial</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for TMotorCANControl.servo_serial</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">serial</span> <span class="kn">import</span> <span class="n">threaded</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A python module to control the CubeMars AK series actuators over the serial port.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">Servo_Params_Serial</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;AK80-9&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;AK80-9&#39;</span><span class="p">,</span> <span class="c1"># name of motor to print out in diagnostics</span>
        <span class="s1">&#39;P_min&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">58.85</span><span class="p">,</span> <span class="c1"># rad (-58.85 rad limit)</span>
        <span class="s1">&#39;P_max&#39;</span> <span class="p">:</span> <span class="mf">58.85</span><span class="p">,</span> <span class="c1"># rad (58.85 rad limit)</span>
        <span class="s1">&#39;V_min&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">20.0</span><span class="p">,</span> <span class="c1"># rad/s (-58.18 rad/s limit)</span>
        <span class="s1">&#39;V_max&#39;</span> <span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span> <span class="c1"># rad/s (58.18 rad/s limit)</span>
        <span class="s1">&#39;Curr_min&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">15.0</span><span class="p">,</span><span class="c1"># A (-60A is the acutal limit)</span>
        <span class="s1">&#39;Curr_max&#39;</span> <span class="p">:</span> <span class="mf">15.0</span><span class="p">,</span> <span class="c1"># A (60A is the acutal limit)</span>
        <span class="s1">&#39;Temp_max&#39;</span> <span class="p">:</span> <span class="mf">40.0</span><span class="p">,</span> <span class="c1"># max mosfet temp in deg C</span>
        <span class="s1">&#39;Kt&#39;</span><span class="p">:</span> <span class="mf">0.115</span><span class="p">,</span> <span class="c1"># Nm before gearbox per A of qaxis current</span>
        <span class="s1">&#39;GEAR_RATIO&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="c1"># 9:1 gear ratio</span>
        <span class="s1">&#39;NUM_POLE_PAIRS&#39;</span> <span class="p">:</span> <span class="mi">21</span> <span class="c1"># 21 pole pairs</span>
    <span class="p">}</span>        
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dictionary with the default parameters for the motors, indexed by their name</span>

<span class="sd">Parameters:</span>
<span class="sd">    Type (str): the name of this type of motor (ie, AK##-##)</span>
<span class="sd">    P_min (float): Minimum position in radians</span>
<span class="sd">    P_max (float): Maximum position in radians</span>
<span class="sd">    V_min (float): Minimum speed command in velocity control in rad/s</span>
<span class="sd">    V_max (float): Maximum speed command in velocity control in rad/s</span>
<span class="sd">    Curr_min (float): Minimum current command during current control in A</span>
<span class="sd">    Curr_max (float): Maximum current command during current control in A</span>
<span class="sd">    Temp_max (float): Temperature above which motor should be turned off in Celsius</span>
<span class="sd">    Kt (float): Torque constant of motor in Nm/A, before gearbox, q-axis</span>
<span class="sd">    GEAR_RATIO (int): The gear ratio of the motor &quot;n&quot; as in n:1</span>
<span class="sd">    NUM_POLE_PAIRS (int): Number of pole pairs in the motor</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">crc16_tab</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x1021</span><span class="p">,</span> <span class="mh">0x2042</span><span class="p">,</span><span class="mh">0x3063</span><span class="p">,</span> <span class="mh">0x4084</span><span class="p">,</span>
<span class="mh">0x50a5</span><span class="p">,</span> <span class="mh">0x60c6</span><span class="p">,</span> <span class="mh">0x70e7</span><span class="p">,</span> <span class="mh">0x8108</span><span class="p">,</span> <span class="mh">0x9129</span><span class="p">,</span> <span class="mh">0xa14a</span><span class="p">,</span> <span class="mh">0xb16b</span><span class="p">,</span> <span class="mh">0xc18c</span><span class="p">,</span><span class="mh">0xd1ad</span><span class="p">,</span>
<span class="mh">0xe1ce</span><span class="p">,</span> <span class="mh">0xf1ef</span><span class="p">,</span> <span class="mh">0x1231</span><span class="p">,</span> <span class="mh">0x0210</span><span class="p">,</span> <span class="mh">0x3273</span><span class="p">,</span> <span class="mh">0x2252</span><span class="p">,</span> <span class="mh">0x52b5</span><span class="p">,</span> <span class="mh">0x4294</span><span class="p">,</span><span class="mh">0x72f7</span><span class="p">,</span>
<span class="mh">0x62d6</span><span class="p">,</span> <span class="mh">0x9339</span><span class="p">,</span> <span class="mh">0x8318</span><span class="p">,</span> <span class="mh">0xb37b</span><span class="p">,</span> <span class="mh">0xa35a</span><span class="p">,</span> <span class="mh">0xd3bd</span><span class="p">,</span> <span class="mh">0xc39c</span><span class="p">,</span> <span class="mh">0xf3ff</span><span class="p">,</span><span class="mh">0xe3de</span><span class="p">,</span>
<span class="mh">0x2462</span><span class="p">,</span> <span class="mh">0x3443</span><span class="p">,</span> <span class="mh">0x0420</span><span class="p">,</span> <span class="mh">0x1401</span><span class="p">,</span> <span class="mh">0x64e6</span><span class="p">,</span> <span class="mh">0x74c7</span><span class="p">,</span> <span class="mh">0x44a4</span><span class="p">,</span> <span class="mh">0x5485</span><span class="p">,</span><span class="mh">0xa56a</span><span class="p">,</span>
<span class="mh">0xb54b</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x9509</span><span class="p">,</span> <span class="mh">0xe5ee</span><span class="p">,</span> <span class="mh">0xf5cf</span><span class="p">,</span> <span class="mh">0xc5ac</span><span class="p">,</span> <span class="mh">0xd58d</span><span class="p">,</span> <span class="mh">0x3653</span><span class="p">,</span><span class="mh">0x2672</span><span class="p">,</span>
<span class="mh">0x1611</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span> <span class="mh">0x76d7</span><span class="p">,</span> <span class="mh">0x66f6</span><span class="p">,</span> <span class="mh">0x5695</span><span class="p">,</span> <span class="mh">0x46b4</span><span class="p">,</span> <span class="mh">0xb75b</span><span class="p">,</span> <span class="mh">0xa77a</span><span class="p">,</span><span class="mh">0x9719</span><span class="p">,</span>
<span class="mh">0x8738</span><span class="p">,</span> <span class="mh">0xf7df</span><span class="p">,</span> <span class="mh">0xe7fe</span><span class="p">,</span> <span class="mh">0xd79d</span><span class="p">,</span> <span class="mh">0xc7bc</span><span class="p">,</span> <span class="mh">0x48c4</span><span class="p">,</span> <span class="mh">0x58e5</span><span class="p">,</span> <span class="mh">0x6886</span><span class="p">,</span><span class="mh">0x78a7</span><span class="p">,</span>
<span class="mh">0x0840</span><span class="p">,</span> <span class="mh">0x1861</span><span class="p">,</span> <span class="mh">0x2802</span><span class="p">,</span> <span class="mh">0x3823</span><span class="p">,</span> <span class="mh">0xc9cc</span><span class="p">,</span> <span class="mh">0xd9ed</span><span class="p">,</span> <span class="mh">0xe98e</span><span class="p">,</span> <span class="mh">0xf9af</span><span class="p">,</span><span class="mh">0x8948</span><span class="p">,</span>
<span class="mh">0x9969</span><span class="p">,</span> <span class="mh">0xa90a</span><span class="p">,</span> <span class="mh">0xb92b</span><span class="p">,</span> <span class="mh">0x5af5</span><span class="p">,</span> <span class="mh">0x4ad4</span><span class="p">,</span> <span class="mh">0x7ab7</span><span class="p">,</span> <span class="mh">0x6a96</span><span class="p">,</span> <span class="mh">0x1a71</span><span class="p">,</span><span class="mh">0x0a50</span><span class="p">,</span>
<span class="mh">0x3a33</span><span class="p">,</span> <span class="mh">0x2a12</span><span class="p">,</span> <span class="mh">0xdbfd</span><span class="p">,</span> <span class="mh">0xcbdc</span><span class="p">,</span> <span class="mh">0xfbbf</span><span class="p">,</span> <span class="mh">0xeb9e</span><span class="p">,</span> <span class="mh">0x9b79</span><span class="p">,</span> <span class="mh">0x8b58</span><span class="p">,</span><span class="mh">0xbb3b</span><span class="p">,</span>
<span class="mh">0xab1a</span><span class="p">,</span> <span class="mh">0x6ca6</span><span class="p">,</span> <span class="mh">0x7c87</span><span class="p">,</span> <span class="mh">0x4ce4</span><span class="p">,</span> <span class="mh">0x5cc5</span><span class="p">,</span> <span class="mh">0x2c22</span><span class="p">,</span> <span class="mh">0x3c03</span><span class="p">,</span> <span class="mh">0x0c60</span><span class="p">,</span><span class="mh">0x1c41</span><span class="p">,</span>
<span class="mh">0xedae</span><span class="p">,</span> <span class="mh">0xfd8f</span><span class="p">,</span> <span class="mh">0xcdec</span><span class="p">,</span> <span class="mh">0xddcd</span><span class="p">,</span> <span class="mh">0xad2a</span><span class="p">,</span> <span class="mh">0xbd0b</span><span class="p">,</span> <span class="mh">0x8d68</span><span class="p">,</span> <span class="mh">0x9d49</span><span class="p">,</span><span class="mh">0x7e97</span><span class="p">,</span>
<span class="mh">0x6eb6</span><span class="p">,</span> <span class="mh">0x5ed5</span><span class="p">,</span> <span class="mh">0x4ef4</span><span class="p">,</span> <span class="mh">0x3e13</span><span class="p">,</span> <span class="mh">0x2e32</span><span class="p">,</span> <span class="mh">0x1e51</span><span class="p">,</span> <span class="mh">0x0e70</span><span class="p">,</span> <span class="mh">0xff9f</span><span class="p">,</span><span class="mh">0xefbe</span><span class="p">,</span>
<span class="mh">0xdfdd</span><span class="p">,</span> <span class="mh">0xcffc</span><span class="p">,</span> <span class="mh">0xbf1b</span><span class="p">,</span> <span class="mh">0xaf3a</span><span class="p">,</span> <span class="mh">0x9f59</span><span class="p">,</span> <span class="mh">0x8f78</span><span class="p">,</span> <span class="mh">0x9188</span><span class="p">,</span> <span class="mh">0x81a9</span><span class="p">,</span><span class="mh">0xb1ca</span><span class="p">,</span>
<span class="mh">0xa1eb</span><span class="p">,</span> <span class="mh">0xd10c</span><span class="p">,</span> <span class="mh">0xc12d</span><span class="p">,</span> <span class="mh">0xf14e</span><span class="p">,</span> <span class="mh">0xe16f</span><span class="p">,</span> <span class="mh">0x1080</span><span class="p">,</span> <span class="mh">0x00a1</span><span class="p">,</span> <span class="mh">0x30c2</span><span class="p">,</span><span class="mh">0x20e3</span><span class="p">,</span>
<span class="mh">0x5004</span><span class="p">,</span> <span class="mh">0x4025</span><span class="p">,</span> <span class="mh">0x7046</span><span class="p">,</span> <span class="mh">0x6067</span><span class="p">,</span> <span class="mh">0x83b9</span><span class="p">,</span> <span class="mh">0x9398</span><span class="p">,</span> <span class="mh">0xa3fb</span><span class="p">,</span> <span class="mh">0xb3da</span><span class="p">,</span><span class="mh">0xc33d</span><span class="p">,</span>
<span class="mh">0xd31c</span><span class="p">,</span> <span class="mh">0xe37f</span><span class="p">,</span> <span class="mh">0xf35e</span><span class="p">,</span> <span class="mh">0x02b1</span><span class="p">,</span> <span class="mh">0x1290</span><span class="p">,</span> <span class="mh">0x22f3</span><span class="p">,</span> <span class="mh">0x32d2</span><span class="p">,</span> <span class="mh">0x4235</span><span class="p">,</span><span class="mh">0x5214</span><span class="p">,</span>
<span class="mh">0x6277</span><span class="p">,</span> <span class="mh">0x7256</span><span class="p">,</span> <span class="mh">0xb5ea</span><span class="p">,</span> <span class="mh">0xa5cb</span><span class="p">,</span> <span class="mh">0x95a8</span><span class="p">,</span> <span class="mh">0x8589</span><span class="p">,</span> <span class="mh">0xf56e</span><span class="p">,</span> <span class="mh">0xe54f</span><span class="p">,</span><span class="mh">0xd52c</span><span class="p">,</span>
<span class="mh">0xc50d</span><span class="p">,</span> <span class="mh">0x34e2</span><span class="p">,</span> <span class="mh">0x24c3</span><span class="p">,</span> <span class="mh">0x14a0</span><span class="p">,</span> <span class="mh">0x0481</span><span class="p">,</span> <span class="mh">0x7466</span><span class="p">,</span> <span class="mh">0x6447</span><span class="p">,</span> <span class="mh">0x5424</span><span class="p">,</span><span class="mh">0x4405</span><span class="p">,</span>
<span class="mh">0xa7db</span><span class="p">,</span> <span class="mh">0xb7fa</span><span class="p">,</span> <span class="mh">0x8799</span><span class="p">,</span> <span class="mh">0x97b8</span><span class="p">,</span> <span class="mh">0xe75f</span><span class="p">,</span> <span class="mh">0xf77e</span><span class="p">,</span> <span class="mh">0xc71d</span><span class="p">,</span> <span class="mh">0xd73c</span><span class="p">,</span><span class="mh">0x26d3</span><span class="p">,</span>
<span class="mh">0x36f2</span><span class="p">,</span> <span class="mh">0x0691</span><span class="p">,</span> <span class="mh">0x16b0</span><span class="p">,</span> <span class="mh">0x6657</span><span class="p">,</span> <span class="mh">0x7676</span><span class="p">,</span> <span class="mh">0x4615</span><span class="p">,</span> <span class="mh">0x5634</span><span class="p">,</span> <span class="mh">0xd94c</span><span class="p">,</span><span class="mh">0xc96d</span><span class="p">,</span>
<span class="mh">0xf90e</span><span class="p">,</span> <span class="mh">0xe92f</span><span class="p">,</span> <span class="mh">0x99c8</span><span class="p">,</span> <span class="mh">0x89e9</span><span class="p">,</span> <span class="mh">0xb98a</span><span class="p">,</span> <span class="mh">0xa9ab</span><span class="p">,</span> <span class="mh">0x5844</span><span class="p">,</span> <span class="mh">0x4865</span><span class="p">,</span><span class="mh">0x7806</span><span class="p">,</span>
<span class="mh">0x6827</span><span class="p">,</span> <span class="mh">0x18c0</span><span class="p">,</span> <span class="mh">0x08e1</span><span class="p">,</span> <span class="mh">0x3882</span><span class="p">,</span> <span class="mh">0x28a3</span><span class="p">,</span> <span class="mh">0xcb7d</span><span class="p">,</span> <span class="mh">0xdb5c</span><span class="p">,</span> <span class="mh">0xeb3f</span><span class="p">,</span><span class="mh">0xfb1e</span><span class="p">,</span>
<span class="mh">0x8bf9</span><span class="p">,</span> <span class="mh">0x9bd8</span><span class="p">,</span> <span class="mh">0xabbb</span><span class="p">,</span> <span class="mh">0xbb9a</span><span class="p">,</span> <span class="mh">0x4a75</span><span class="p">,</span> <span class="mh">0x5a54</span><span class="p">,</span> <span class="mh">0x6a37</span><span class="p">,</span> <span class="mh">0x7a16</span><span class="p">,</span><span class="mh">0x0af1</span><span class="p">,</span>
<span class="mh">0x1ad0</span><span class="p">,</span> <span class="mh">0x2ab3</span><span class="p">,</span> <span class="mh">0x3a92</span><span class="p">,</span> <span class="mh">0xfd2e</span><span class="p">,</span> <span class="mh">0xed0f</span><span class="p">,</span> <span class="mh">0xdd6c</span><span class="p">,</span> <span class="mh">0xcd4d</span><span class="p">,</span> <span class="mh">0xbdaa</span><span class="p">,</span><span class="mh">0xad8b</span><span class="p">,</span>
<span class="mh">0x9de8</span><span class="p">,</span> <span class="mh">0x8dc9</span><span class="p">,</span> <span class="mh">0x7c26</span><span class="p">,</span> <span class="mh">0x6c07</span><span class="p">,</span> <span class="mh">0x5c64</span><span class="p">,</span> <span class="mh">0x4c45</span><span class="p">,</span> <span class="mh">0x3ca2</span><span class="p">,</span> <span class="mh">0x2c83</span><span class="p">,</span><span class="mh">0x1ce0</span><span class="p">,</span>
<span class="mh">0x0cc1</span><span class="p">,</span> <span class="mh">0xef1f</span><span class="p">,</span> <span class="mh">0xff3e</span><span class="p">,</span> <span class="mh">0xcf5d</span><span class="p">,</span> <span class="mh">0xdf7c</span><span class="p">,</span> <span class="mh">0xaf9b</span><span class="p">,</span> <span class="mh">0xbfba</span><span class="p">,</span> <span class="mh">0x8fd9</span><span class="p">,</span><span class="mh">0x9ff8</span><span class="p">,</span>
<span class="mh">0x6e17</span><span class="p">,</span> <span class="mh">0x7e36</span><span class="p">,</span> <span class="mh">0x4e55</span><span class="p">,</span> <span class="mh">0x5e74</span><span class="p">,</span> <span class="mh">0x2e93</span><span class="p">,</span> <span class="mh">0x3eb2</span><span class="p">,</span> <span class="mh">0x0ed1</span><span class="p">,</span> <span class="mh">0x1ef0</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">CRC 16 table as given in the manual, to be used to verify the packets recived</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">PARAMETER_FLAGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># parameter       : flag</span>
    <span class="s1">&#39;MOSFET_TEMP&#39;</span>     <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>      
    <span class="s1">&#39;MOTOR_TEMP&#39;</span>      <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> 
    <span class="s1">&#39;OUTPUT_CURRENT&#39;</span>  <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;INPUT_CURRENT&#39;</span>   <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;D_CURRENT&#39;</span>       <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;Q_CURRENT&#39;</span>       <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s1">&#39;DUTY_CYCLE&#39;</span>      <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;MOTOR_SPEED&#39;</span>     <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;INPUT_VOLTAGE&#39;</span>   <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;MOTOR_ERROR_FLAG&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s1">&#39;MOTOR_POSITION&#39;</span>  <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span>
    <span class="s1">&#39;MOTOR_ID&#39;</span>        <span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A dictionary of flags, where 1 means enable the desired parameter during feedback, and 0 means disable.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">ERROR_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_NONE&#39;</span><span class="p">,</span>
    <span class="mi">1</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_OVER_VOLTAGE&#39;</span><span class="p">,</span>
    <span class="mi">2</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_UNDER_VOLTAGE&#39;</span><span class="p">,</span>
    <span class="mi">3</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_DRIVE&#39;</span><span class="p">,</span>
    <span class="mi">4</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_ABS_OVER_CURRENT&#39;</span><span class="p">,</span>
    <span class="mi">5</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_OVER_TEMP_FET&#39;</span><span class="p">,</span>
    <span class="mi">6</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_OVER_TEMP_MOTOR&#39;</span><span class="p">,</span>
    <span class="mi">7</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_GATE_DRIVER_OVER_VOLTAGE&#39;</span><span class="p">,</span>
    <span class="mi">8</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_GATE_DRIVER_UNDER_VOLTAGE&#39;</span><span class="p">,</span>
    <span class="mi">9</span>  <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_MCU_UNDER_VOLTAGE&#39;</span><span class="p">,</span>
    <span class="mi">10</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_BOOTING_FROM_WATCHDOG_RESET&#39;</span><span class="p">,</span>
    <span class="mi">11</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_ENCODER_SPI&#39;</span><span class="p">,</span>
    <span class="mi">12</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_ENCODER_SINCOS_BELOW_MIN_AMPLITUDE&#39;</span><span class="p">,</span>
    <span class="mi">13</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_ENCODER_SINCOS_ABOVE_MAX_AMPLITUDE&#39;</span><span class="p">,</span>
    <span class="mi">14</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_FLASH_CORRUPTION&#39;</span><span class="p">,</span>
    <span class="mi">15</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_1&#39;</span><span class="p">,</span>
    <span class="mi">16</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_2&#39;</span><span class="p">,</span>
    <span class="mi">17</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_3&#39;</span><span class="p">,</span>
    <span class="mi">18</span> <span class="p">:</span> <span class="s1">&#39;FAULT_CODE_UNBALANCED_CURRENTS&#39;</span><span class="p">,</span>
<span class="p">}</span>    
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A dictionary mapping error code numbers to the name of the error code</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="COMM_PACKET_ID"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.COMM_PACKET_ID">[docs]</a><span class="k">class</span> <span class="nc">COMM_PACKET_ID</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basically used as ENUM to identify what each packet ID does</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">COMM_FW_VERSION</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">COMM_JUMP_TO_BOOTLOADER</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">COMM_ERASE_NEW_APP</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">COMM_WRITE_NEW_APP_DATA</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">COMM_GET_VALUES</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">COMM_SET_DUTY</span> <span class="o">=</span>  <span class="mi">5</span>
    <span class="n">COMM_SET_CURRENT</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">COMM_SET_CURRENT_BRAKE</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">COMM_SET_RPM</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">COMM_SET_POS</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">COMM_SET_HANDBRAKE</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">COMM_SET_DETECT</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="c1"># COMM_GET_POS = 16</span>
    <span class="n">COMM_ROTOR_POSITION</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="n">COMM_GET_VALUES_SETUP</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">COMM_SET_POS_SPD</span> <span class="o">=</span> <span class="mi">91</span>
    <span class="n">COMM_SET_POS_MULTI</span> <span class="o">=</span> <span class="mi">92</span>
    <span class="n">COMM_SET_POS_SINGLE</span> <span class="o">=</span> <span class="mi">93</span>
    <span class="n">COMM_SET_POS_UNLIMITED</span> <span class="o">=</span> <span class="mi">94</span>
    <span class="n">COMM_SET_POS_ORIGIN</span> <span class="o">=</span> <span class="mi">95</span></div>

<div class="viewcode-block" id="buffer_append_int16"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_int16">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_int16</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 16 bit signed integer into 2 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">))</span></div>

<span class="c1"># Buffer allocation for unsigned 16 bit</span>
<div class="viewcode-block" id="buffer_append_uint16"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_uint16">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_uint16</span><span class="p">(</span> <span class="n">buffer</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 16 bit unsigned integer into 2 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">))</span></div>
    
<span class="c1"># Buffer allocation for 32 bit</span>
<div class="viewcode-block" id="buffer_append_int32"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_int32">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 32 bit signed integer into 4 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span></div>

<span class="c1"># Buffer allocation for 32 bit</span>
<div class="viewcode-block" id="buffer_append_uint32"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_uint32">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_uint32</span><span class="p">(</span> <span class="n">buffer</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 32 bit unsigned integer into 4 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x000000FF</span><span class="p">))</span></div>

<span class="c1"># Buffer allocation for 64 bit</span>
<div class="viewcode-block" id="buffer_append_int64"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_int64">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_int64</span><span class="p">(</span> <span class="n">buffer</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 64 bit signed integer into 8 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span></div>

<span class="c1"># Buffer allocation for Unsigned 64 bit</span>
<div class="viewcode-block" id="buffer_append_uint64"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_append_uint64">[docs]</a><span class="k">def</span> <span class="nf">buffer_append_uint64</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split a 64 bit unsigned integer into 8 bytes and append to buffer.</span>

<span class="sd">    Args:</span>
<span class="sd">        Buffer: memory allocated to store data.</span>
<span class="sd">        number: value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">number</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="mh">0x00000000000000FF</span><span class="p">))</span></div>

<div class="viewcode-block" id="buffer_get_int8"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_get_int8">[docs]</a><span class="k">def</span> <span class="nf">buffer_get_int8</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Grab the 8 bit integer at data[ind]</span>

<span class="sd">    Args:</span>
<span class="sd">        buffer: array with bytes of data</span>
<span class="sd">        ind: location to index   </span>

<span class="sd">    Returns:</span>
<span class="sd">        8 bit integer at data[ind] </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span></div>

<div class="viewcode-block" id="buffer_get_int16"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_get_int16">[docs]</a><span class="k">def</span> <span class="nf">buffer_get_int16</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Grab the 16 bit integer at data[ind:ind+1]</span>

<span class="sd">    Args:</span>
<span class="sd">        buffer: array with bytes of data</span>
<span class="sd">        ind: location to index    </span>

<span class="sd">    Returns:</span>
<span class="sd">        16 bit integer at data[ind:ind+1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="buffer_get_int32"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.buffer_get_int32">[docs]</a><span class="k">def</span> <span class="nf">buffer_get_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Grab the 32 bit integer at data[ind:ind+3]</span>

<span class="sd">    Args:</span>
<span class="sd">        buffer: array with bytes of data</span>
<span class="sd">        ind: location to index</span>

<span class="sd">    Returns:</span>
<span class="sd">        32-bit signed integer at data[ind:ind+3]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]))</span></div>

<div class="viewcode-block" id="crc16"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.crc16">[docs]</a><span class="k">def</span> <span class="nf">crc16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the crc16 value for the given data array and data length. </span>
<span class="sd">    This is just translated to python from the C code in the manual on the cubmars website.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: array of data to creat checksum value for</span>
<span class="sd">        DL: data length</span>

<span class="sd">    Returns:</span>
<span class="sd">        16-bit integer checksum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cksum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DL</span><span class="p">):</span>
        <span class="n">cksum</span> <span class="o">=</span> <span class="n">crc16_tab</span><span class="p">[((</span><span class="n">cksum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">cksum</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="n">cksum</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_packet"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.create_packet">[docs]</a><span class="k">def</span> <span class="nf">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Packages the data into a packet to be sent.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: array of N+1 bytes of data, [packet id, data_1, ..., data_N]</span>

<span class="sd">    Returns:</span>
<span class="sd">        packet: array in the format, [0x02, data length, packet id, data_1, ..., data_N, crc_1, crc_2, 0x03]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">DL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DL</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Tried to send packet longer than 256 bytes!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span>
        <span class="n">packet</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DL</span><span class="p">)</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
        <span class="n">packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">packet</span></div>

<div class="viewcode-block" id="parse_packet"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.parse_packet">[docs]</a><span class="k">def</span> <span class="nf">parse_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the packet makes sense, and get the data out of it.</span>

<span class="sd">    Args:</span>
<span class="sd">        packet: array in the format [0x02, data length, packet id, data_1, ..., data_N, crc_1, crc_2, 0x03]</span>

<span class="sd">    Returns:</span>
<span class="sd">        data: Just the packet id and actual data from the recieved packet, [packet id, data_1, ..., data_N]</span>
<span class="sd">        None: returns None if the packet failed to successfully parse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">DL</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="o">+</span><span class="n">DL</span><span class="p">]</span>
        <span class="n">crc</span> <span class="o">=</span> <span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">DL</span><span class="p">:</span><span class="n">DL</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crc</span> <span class="o">==</span> <span class="n">crc16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DL</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>
                
<div class="viewcode-block" id="servo_serial_motor_state"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.servo_serial_motor_state">[docs]</a><span class="k">class</span> <span class="nc">servo_serial_motor_state</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object representing the state of the motor</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="servo_serial_motor_state.__init__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.servo_serial_motor_state.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the motor state to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mos_temperature</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_temperature</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iq_current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_voltage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_set</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controlID</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="servo_serial_motor_state.set_state"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.servo_serial_motor_state.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">mos_temperature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">motor_temperature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">output_current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">input_current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">id_current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">iq_current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">duty</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">speed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">input_voltage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">position_set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">controlID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">Vd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">Vq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">acceleration</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the motor state based on input to the function. If any field is not specified,</span>
<span class="sd">        then that field will not be altered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mos_temperature</span> <span class="o">=</span> <span class="n">mos_temperature</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mos_temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mos_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_temperature</span> <span class="o">=</span> <span class="n">motor_temperature</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">motor_temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_current</span> <span class="o">=</span> <span class="n">output_current</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">output_current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_current</span> <span class="o">=</span> <span class="n">input_current</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">input_current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_current</span> <span class="o">=</span> <span class="n">id_current</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">id_current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iq_current</span> <span class="o">=</span> <span class="n">iq_current</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iq_current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">iq_current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duty</span> <span class="o">=</span> <span class="n">duty</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">duty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">duty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">speed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_voltage</span> <span class="o">=</span> <span class="n">input_voltage</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">input_voltage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_set</span> <span class="o">=</span> <span class="n">position_set</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">position_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controlID</span> <span class="o">=</span> <span class="n">controlID</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">controlID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vd</span> <span class="o">=</span> <span class="n">Vd</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Vd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vq</span> <span class="o">=</span> <span class="n">Vq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Vq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">acceleration</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">acceleration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span></div>

<div class="viewcode-block" id="servo_serial_motor_state.__str__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.servo_serial_motor_state.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String showing each of the fields in the motor state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Mos Temp: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mos_temperature</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Motor Temp: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_temperature</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Output Current: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_current</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Input Current: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_current</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">id current: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id_current</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">iq current: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iq_current</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">duty: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duty</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">speed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">input voltage: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_voltage</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">position: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position_set</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">controlID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">controlID</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Vd: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Vd</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Vq: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Vq</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Accel: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">acceleration</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">s</span></div></div>

<span class="c1"># possible states for the controller</span>
<div class="viewcode-block" id="SERVO_SERIAL_CONTROL_STATE"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.SERVO_SERIAL_CONTROL_STATE">[docs]</a><span class="k">class</span> <span class="nc">SERVO_SERIAL_CONTROL_STATE</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Enum to keep track of different control states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DUTY_CYCLE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">CURRENT_LOOP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CURRENT_BRAKE</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">VELOCITY</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">POSITION</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">HANDBRAKE</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">POSITION_VELOCITY</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">IDLE</span> <span class="o">=</span> <span class="mi">7</span></div>

<div class="viewcode-block" id="motor_listener"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener">[docs]</a><span class="k">class</span> <span class="nc">motor_listener</span><span class="p">(</span><span class="n">serial</span><span class="o">.</span><span class="n">threaded</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the pyserial &quot;Protocol&quot; class to handle messages asynchronously</span>
<span class="sd">    TODO when pyserial implmements asyncio support, switch to that</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="motor_listener.connection_made"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener.connection_made">[docs]</a>    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Could add other things to happen here on connection initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            transport: the connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connection_made</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span></div>

<div class="viewcode-block" id="motor_listener.connection_lost"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener.connection_lost">[docs]</a>    <span class="k">def</span> <span class="nf">connection_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Could add other things to happen here on connection termination.</span>

<span class="sd">        Args:</span>
<span class="sd">            transport: the connection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connection_made</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span></div>

<div class="viewcode-block" id="motor_listener.__init__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the class, including the state machine variables and a reference</span>
<span class="sd">        to the motor manager in the main thread that this class will update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 0 : ready, 1 : message started (0x02), 2 : known DL, 3 : ready data, 5 : expect 0x03</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DL</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="motor_listener.data_received"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener.data_received">[docs]</a>    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle data that&#39;s been recieved, by stepping through a state machine one byte at a time.</span>
<span class="sd">        States:</span>
<span class="sd">            0: expecting 0x02 for beginning of next message</span>
<span class="sd">            1: expecting data length field</span>
<span class="sd">            2: will keep reading data until DL + 2</span>
<span class="sd">            3: expecting 0x03 for ending of this message</span>

<span class="sd">        Args:</span>
<span class="sd">            data: array of received data to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(f&quot;\n {len(data)}&quot;)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DL</span> <span class="o">=</span> <span class="n">d</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">DL</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_packet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span></div>
                
<div class="viewcode-block" id="motor_listener.handle_packet"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.motor_listener.handle_packet">[docs]</a>    <span class="k">def</span> <span class="nf">handle_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called whenever the state machine finishes reading a packet, </span>
<span class="sd">        to update motor manager object.</span>

<span class="sd">        Args:</span>
<span class="sd">            packet: array of data to parse.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># print(packet)</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="o">+</span><span class="n">DL</span><span class="p">]</span>
            <span class="n">crc</span> <span class="o">=</span> <span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">DL</span><span class="p">:</span><span class="n">DL</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="n">crc16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DL</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">update_async</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div></div>

<span class="c1"># the user-facing class that manages the motor.</span>
<div class="viewcode-block" id="TMotorManager_servo_serial"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial">[docs]</a><span class="k">class</span> <span class="nc">TMotorManager_servo_serial</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The user-facing class that manages the motor. This class should be</span>
<span class="sd">    used in the &quot;context&quot; of a with as block, in order to safely enter/exit</span>
<span class="sd">    control of the motor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TMotorManager_servo_serial.__init__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;/dev/ttyUSB0&#39;</span><span class="p">,</span> <span class="n">baud</span><span class="o">=</span><span class="mi">961200</span><span class="p">,</span> <span class="n">motor_params</span><span class="o">=</span><span class="n">Servo_Params_Serial</span><span class="p">[</span><span class="s1">&#39;AK80-9&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the motor manager. Note that this will not turn on the motor, </span>
<span class="sd">        until __enter__ is called (automatically called in a with block)</span>

<span class="sd">        Args:</span>
<span class="sd">            port: the name of the serial port to connect to (ie, /dev/ttyUSB0, COM3, etc)</span>
<span class="sd">            baud: the baud rate to use for connection. Should always be 961200 as far as I can tell.</span>
<span class="sd">            motor_params: A parameter dictionary defining the motor parameters, as defined above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span> <span class="o">=</span> <span class="n">motor_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing device: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span> <span class="o">=</span> <span class="n">servo_serial_motor_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span> <span class="o">=</span> <span class="n">servo_serial_motor_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># overwrite with byte array of command to send on update()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO verify these work for other motor types!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radps_per_ERPM</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">/</span><span class="mi">60</span> <span class="c1"># 5.82E-04 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad_per_Eang</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s1">&#39;NUM_POLE_PAIRS&#39;</span><span class="p">])</span> <span class="c1"># 1.85e-4</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updated_async</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span> <span class="o">=</span> <span class="kc">None</span></div>
        
<div class="viewcode-block" id="TMotorManager_servo_serial.__enter__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.__enter__">[docs]</a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to safely power the motor on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="p">:</span>
            <span class="c1"># begin serial connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">baud</span><span class="p">,</span> 
                <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span><span class="p">,</span>
                <span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span>
                <span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">EIGHTBITS</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> 
                <span class="n">inter_byte_timeout</span><span class="o">=</span><span class="mf">0.001</span>
                <span class="p">)</span>

            <span class="c1"># start another thread to handle recieved data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">threaded</span><span class="o">.</span><span class="n">ReaderThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ser</span><span class="p">,</span> <span class="n">motor_listener</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_listener</span><span class="o">.</span><span class="n">motor</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="c1"># send startup sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span>

            <span class="c1"># tell the motor to send back all parameters</span>
            <span class="c1"># TODO expand to allow user to only request some data, could be faster</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_motor_parameter_return_format_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span>

            <span class="c1"># tell motor to send current position (for some reason current position is not in the other parameters)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin_position_feedback</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span>

            <span class="c1"># don&#39;t do anything else</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enter_idle_mode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_connection</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;device: {self.device_info_string()} not connected!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">()</span><span class="si">}</span><span class="s2"> successfully connected.&quot;</span><span class="p">)</span>

            <span class="c1"># return the safely entered motor manager object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it&#39;s already been entered!</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already entered device: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="TMotorManager_servo_serial.__exit__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.__exit__">[docs]</a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to safely power the motor off and close the reader thread and serial port.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Turning off control for device: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span>
        <span class="c1"># end reading thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> 

        <span class="c1"># power down motor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_duty_cycle</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> 

        <span class="c1"># end serial connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 

        <span class="c1"># if this was ended due to an error, print the stack trace</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">etype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.check_connection"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.check_connection">[docs]</a>    <span class="k">def</span> <span class="nf">check_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For now, just sends some parameter read commands and waits 0.2 seconds to</span>
<span class="sd">        see if we got a response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_specific_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_motor_parameters</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_specific_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_motor_parameters</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_specific_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_motor_parameters</span><span class="p">())</span>
        <span class="c1"># slight delay to ensure connection!</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updated_async</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.update_async"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.update_async">[docs]</a>    <span class="k">def</span> <span class="nf">update_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the asynchronous motor state. Called by a reader thread.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: An array of N bytes of data to parse, [packet id, data_1, ..., data_N]</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the packet recieved contains an error code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updated_async</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">packet_ID</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">packet_ID</span> <span class="ow">in</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_GET_VALUES</span><span class="p">,</span> <span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_GET_VALUES_SETUP</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_motor_parameters_async</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># calculate acceleration</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">speed</span><span class="o">/</span><span class="n">dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_time</span> <span class="o">=</span> <span class="n">now</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">packet_ID</span> <span class="o">==</span> <span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_ROTOR_POSITION</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_position_feedback_async</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weird packet&quot;</span><span class="p">)</span>
        <span class="c1"># elif (packet_ID == COMM_PACKET_ID.COMM_SET_POS):</span>
        <span class="c1">#     self.parse_set_position_feedback_async(data)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">ERROR_CODES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">error</span><span class="p">])</span></div>

        

    <span class="c1"># comm data parsing </span>
<div class="viewcode-block" id="TMotorManager_servo_serial.parse_position_feedback_async"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.parse_position_feedback_async">[docs]</a>    <span class="k">def</span> <span class="nf">parse_position_feedback_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this motor&#39;s asynch position based on recieved data</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data array to parse the position from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mf">1000.0</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.parse_set_position_feedback_async"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.parse_set_position_feedback_async">[docs]</a>    <span class="k">def</span> <span class="nf">parse_set_position_feedback_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this motor&#39;s asynch position based on recieved data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data array to parse the position from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># not sure why the constant varies here, maybe the streaming data is more accurate?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mf">1000000.0</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.parse_motor_parameters_async"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.parse_motor_parameters_async">[docs]</a>    <span class="k">def</span> <span class="nf">parse_motor_parameters_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this motor&#39;s asynch state (except position) based on received data</span>
<span class="sd"> </span>
<span class="sd">        Args:</span>
<span class="sd">            data: The data array to parse the parameters from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">mos_temperature</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">10.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">motor_temperature</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">10.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">output_current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">input_current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">id_current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">iq_current</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">duty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">1000.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">input_voltage</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">10.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">24</span>
        <span class="c1"># TODO investigate what&#39;s in the 24 reserved bytes? Maybe it&#39;s interesting to record?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">position_set</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">1000000.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">controlID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">Vd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">1000.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span><span class="o">.</span><span class="n">Vq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buffer_get_int32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="mf">1000.0</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">4</span></div>
    
<div class="viewcode-block" id="TMotorManager_servo_serial.send_command"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.send_command">[docs]</a>    <span class="k">def</span> <span class="nf">send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the current command that the user has specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># use the thread-safe method to write the command, so that we don&#39;t access the serial </span>
            <span class="c1"># object while the reader thread is using it!!</span>
            <span class="c1"># TODO when pyserial adds full asyncio support, consider switching to that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">)</span></div>
            

<div class="viewcode-block" id="TMotorManager_servo_serial._send_specific_command"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial._send_specific_command">[docs]</a>    <span class="k">def</span> <span class="nf">_send_specific_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the specified command rather than the current value of &lt;this object&gt;._command </span>

<span class="sd">        Args:</span>
<span class="sd">            command: bytearray with the command to send.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># use the thread-safe method to write the command, so that we don&#39;t access the serial </span>
            <span class="c1"># object while the reader thread is using it!!</span>
            <span class="c1"># TODO when pyserial adds full asyncio support, consider switching to that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader_thread</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.update"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronizes the current motor state with the asynchronously updated state.</span>
<span class="sd">        Sends the current motor command</span>
<span class="sd">        Sends the command to get parameter feedback</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if this method is called before the motor is entered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Tried to update motor state before safely powering on for device: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span>
        
        <span class="c1"># send the user specified command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span>

        <span class="c1"># send the command to get parameters (message will be read in other thread)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_specific_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_motor_parameters</span><span class="p">())</span>
        

        <span class="c1"># synchronize user-facing state with most recent async state</span>
        <span class="c1"># TODO implement some filtering on the async state, if it gets multiple updates</span>
        <span class="c1"># between user requested updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state_async</span></div>
        
    <span class="c1"># comm protocol commands</span>
<div class="viewcode-block" id="TMotorManager_servo_serial.power_on"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.power_on">[docs]</a>    <span class="k">def</span> <span class="nf">power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send the startup sequence command. Not sure why it&#39;s like this, but the </span>
<span class="sd">        command is [0x40, 0x80, 0x20, 0x02, 0x21, 0xc0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.power_off"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.power_off">[docs]</a>    <span class="k">def</span> <span class="nf">power_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        There is no official power off command that I can see, so this will</span>
<span class="sd">        set the duty cycle to 0.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_duty_cycle</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">()</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_idle_mode"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_idle_mode">[docs]</a>    <span class="k">def</span> <span class="nf">enter_idle_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to IDLE and current command to none.</span>
<span class="sd">        In this mode, no command will be sent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">IDLE</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_velocity_control"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_velocity_control">[docs]</a>    <span class="k">def</span> <span class="nf">enter_velocity_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to VELOCITY</span>
<span class="sd">        In this mode, you can send a certain motion speed to motor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">VELOCITY</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_position_control"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_position_control">[docs]</a>    <span class="k">def</span> <span class="nf">enter_position_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to POSITION</span>
<span class="sd">        In this mode, you can send a certain position to motor, the motor will run to the specified</span>
<span class="sd">        position, (default speed 12000erpm acceleration 40000erpm)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">POSITION</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_position_velocity_control"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_position_velocity_control">[docs]</a>    <span class="k">def</span> <span class="nf">enter_position_velocity_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to POSITION_VELOCITY</span>
<span class="sd">        In this mode, you can send a certain position, speed and acceleration to motor.</span>
<span class="sd">        The motor will run at a given acceleration and maximum speed to a specified</span>
<span class="sd">        position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">POSITION_VELOCITY</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_current_control"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_current_control">[docs]</a>    <span class="k">def</span> <span class="nf">enter_current_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to CURENT_LOOP</span>
<span class="sd">        In this mode, you can send an Iq current to motor, the motor output torque = Iq *KT, so it can</span>
<span class="sd">        be used as a torque loop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">CURRENT_LOOP</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.enter_duty_cycle_control"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.enter_duty_cycle_control">[docs]</a>    <span class="k">def</span> <span class="nf">enter_duty_cycle_control</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the control state to DUTY_CYCLE</span>
<span class="sd">        In this mode, you can send a certain duty cycle voltage to motor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">=</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">DUTY_CYCLE</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_duty_cycle"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_duty_cycle">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_duty_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a certain duty cycle voltage to motor</span>

<span class="sd">        Args:</span>
<span class="sd">            duty: -1.0 to 1.0 duty cycle to use</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">duty</span> <span class="o">*</span> <span class="mf">100000.0</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_SET_DUTY</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_speed_ERPM"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_speed_ERPM">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_speed_ERPM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a certain motion speed to motor</span>

<span class="sd">        Args:</span>
<span class="sd">            speed: speed to use in ERPM, sign denotes direction</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_SET_RPM</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_current_loop"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_current_loop">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_current_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send am Iq current to motor, the motor output torque = Iq *KT, so it can</span>
<span class="sd">        be used as a torque loop</span>

<span class="sd">        Args:</span>
<span class="sd">            current: q axis current to use in A, sign denotes direction</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">current</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_SET_CURRENT</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_position"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_position">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a certain position to motor, the motor will run to the specified</span>
<span class="sd">        position, (default speed 12000erpm acceleration 40000erpm)</span>

<span class="sd">        Args:</span>
<span class="sd">            pos: Desired position in degrees</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="o">*</span><span class="mi">1000000</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_SET_POS</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_position_velocity"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_position_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_position_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a certain position, speed and acceleration to motor.</span>
<span class="sd">        The motor will run at a given acceleration and maximum speed to a specified</span>
<span class="sd">        position.</span>

<span class="sd">        Args:</span>
<span class="sd">            pos: Desired position in degrees</span>
<span class="sd">            vel: Desired speed in ERPM</span>
<span class="sd">            acc: Desired acceleration in ERPM/minute? TODO verify this</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 4 byte pos * 1000, 4 byte vel * 1, 4 byte a * 1</span>
        <span class="n">buffer</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="o">*</span><span class="mi">1000000</span><span class="p">))</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">vel</span><span class="p">))</span>
        <span class="n">buffer_append_int32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_SET_POS_SPD</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_multi_turn"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_multi_turn">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_multi_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell the motor to operate in multi-turn mode, rather than being limited to </span>
<span class="sd">        Just 360 degrees of position feedback.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x02</span> <span class="p">,</span><span class="mh">0x05</span> <span class="p">,</span><span class="mh">0x5C</span> <span class="p">,</span><span class="mh">0x00</span> <span class="p">,</span><span class="mh">0x00</span> <span class="p">,</span><span class="mh">0x00</span> <span class="p">,</span><span class="mh">0x00</span> <span class="p">,</span><span class="mh">0x9E</span> <span class="p">,</span><span class="mh">0x19</span> <span class="p">,</span><span class="mh">0x03</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_zero_position"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_zero_position">[docs]</a>    <span class="k">def</span> <span class="nf">set_zero_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the current position of the motor to be the new zero position.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">cmd</span></div>
    
<div class="viewcode-block" id="TMotorManager_servo_serial.comm_set_motor_parameter_return_format_all"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_set_motor_parameter_return_format_all">[docs]</a>    <span class="k">def</span> <span class="nf">comm_set_motor_parameter_return_format_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell the motor to send back all possible fields when an update is requested.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_GET_VALUES_SETUP</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_begin_position_feedback"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_begin_position_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">comm_begin_position_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell the motor to send back its current position every 10ms</span>

<span class="sd">        Args:</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">])</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.comm_get_motor_parameters"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.comm_get_motor_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">comm_get_motor_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_command</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request the current motor parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            set_command: set the TMotorManager&#39;s current command to this if True</span>

<span class="sd">        Returns:</span>
<span class="sd">            The command as a bytearray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">COMM_PACKET_ID</span><span class="o">.</span><span class="n">COMM_GET_VALUES</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">create_packet</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">set_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">return</span> <span class="n">cmd</span></div>
        
    <span class="c1"># getters for motor state</span>
<div class="viewcode-block" id="TMotorManager_servo_serial.get_temperature_celsius"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_temperature_celsius">[docs]</a>    <span class="k">def</span> <span class="nf">get_temperature_celsius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated motor temperature in degrees C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">mos_temperature</span></div>
    
<div class="viewcode-block" id="TMotorManager_servo_serial.get_motor_error_code"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_motor_error_code">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_error_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated motor error code.</span>
<span class="sd">        Note the program should throw a runtime error before you get a chance to read</span>
<span class="sd">        this value if it is ever anything besides 0.</span>

<span class="sd">        Codes:</span>
<span class="sd">            0  : &#39;FAULT_CODE_NONE&#39;</span>
<span class="sd">            1  : &#39;FAULT_CODE_OVER_VOLTAGE&#39;</span>
<span class="sd">            2  : &#39;FAULT_CODE_UNDER_VOLTAGE&#39;</span>
<span class="sd">            3  : &#39;FAULT_CODE_DRIVE&#39;</span>
<span class="sd">            4  : &#39;FAULT_CODE_ABS_OVER_CURRENT&#39;</span>
<span class="sd">            5  : &#39;FAULT_CODE_OVER_TEMP_FET&#39;</span>
<span class="sd">            6  : &#39;FAULT_CODE_OVER_TEMP_MOTOR&#39;</span>
<span class="sd">            7  : &#39;FAULT_CODE_GATE_DRIVER_OVER_VOLTAGE&#39;</span>
<span class="sd">            8  : &#39;FAULT_CODE_GATE_DRIVER_UNDER_VOLTAGE&#39;</span>
<span class="sd">            9  : &#39;FAULT_CODE_MCU_UNDER_VOLTAGE&#39;</span>
<span class="sd">            10 : &#39;FAULT_CODE_BOOTING_FROM_WATCHDOG_RESET&#39;</span>
<span class="sd">            11 : &#39;FAULT_CODE_ENCODER_SPI&#39;</span>
<span class="sd">            12 : &#39;FAULT_CODE_ENCODER_SINCOS_BELOW_MIN_AMPLITUDE&#39;</span>
<span class="sd">            13 : &#39;FAULT_CODE_ENCODER_SINCOS_ABOVE_MAX_AMPLITUDE&#39;</span>
<span class="sd">            14 : &#39;FAULT_CODE_FLASH_CORRUPTION&#39;</span>
<span class="sd">            15 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_1&#39;</span>
<span class="sd">            16 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_2&#39;</span>
<span class="sd">            17 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_3&#39;</span>
<span class="sd">            18 : &#39;FAULT_CODE_UNBALANCED_CURRENTS&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">error</span></div>

    <span class="k">def</span> <span class="nf">get_motor_error_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ERROR_CODES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">error</span><span class="p">]</span>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_current_qaxis_amps"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_current_qaxis_amps">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_qaxis_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated qaxis current in amps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">iq_current</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_current_daxis_amps"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_current_daxis_amps">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_daxis_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated qaxis current in amps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">id_current</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_current_bus_amps"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_current_bus_amps">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_bus_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated qaxis current in amps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">input_current</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_voltage_qaxis_volts"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_voltage_qaxis_volts">[docs]</a>    <span class="k">def</span> <span class="nf">get_voltage_qaxis_volts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated qaxis voltage in volts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">Vq</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_voltage_daxis_volts"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_voltage_daxis_volts">[docs]</a>    <span class="k">def</span> <span class="nf">get_voltage_daxis_volts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated daxis voltage in volts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">Vd</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_voltage_bus_volts"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_voltage_bus_volts">[docs]</a>    <span class="k">def</span> <span class="nf">get_voltage_bus_volts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated input voltage in volts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">input_current</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_output_angle_radians"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_output_angle_radians">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_angle_radians</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        The most recently updated output angle in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad_per_Eang</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_output_velocity_radians_per_second"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_output_velocity_radians_per_second">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_velocity_radians_per_second</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated output velocity in radians per second</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">speed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radps_per_ERPM</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_output_acceleration_radians_per_second_squared"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_output_acceleration_radians_per_second_squared">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_acceleration_radians_per_second_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated output acceleration in radians per second per second</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">acceleration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radps_per_ERPM</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_output_torque_newton_meters"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_output_torque_newton_meters">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_torque_newton_meters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            the most recently updated output torque in Nm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_qaxis_amps</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;Kt&quot;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">]</span></div>

    <span class="c1"># user facing setters </span>
<div class="viewcode-block" id="TMotorManager_servo_serial.set_output_velocity_radians_per_second"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_output_velocity_radians_per_second">[docs]</a>    <span class="k">def</span> <span class="nf">set_output_velocity_radians_per_second</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current command to the desired velocity.</span>
<span class="sd">        Note, this does not send a command, it updates the TMotorManager&#39;s saved command,</span>
<span class="sd">        which will be sent when update() is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            vel: The desired output speed in rad/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;V_max&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot control using speed mode for angles with magnitude greater than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;V_max&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;rad/s!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">VELOCITY</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attempted to send speed command without entering speed control &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">comm_set_speed_ERPM</span><span class="p">(</span><span class="n">vel</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">radps_per_ERPM</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_duty_cycle_percent"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_duty_cycle_percent">[docs]</a>    <span class="k">def</span> <span class="nf">set_duty_cycle_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current command to the desired duty cycle.</span>
<span class="sd">        Note, this does not send a command, it updates the TMotorManager&#39;s saved command,</span>
<span class="sd">        which will be sent when update() is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            duty: The desired duty cycle -1.0 to 1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">duty</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot control using duty cycle mode for more than 100 percent duty!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">DUTY_CYCLE</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attempted to duty cycle command without entering duty cycle control &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">comm_set_duty_cycle</span><span class="p">(</span><span class="n">duty</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_motor_current_qaxis_amps"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_motor_current_qaxis_amps">[docs]</a>    <span class="k">def</span> <span class="nf">set_motor_current_qaxis_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current command to the desired current.</span>
<span class="sd">        Note, this does not send a command, it updates the TMotorManager&#39;s saved command,</span>
<span class="sd">        which will be sent when update() is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            curr: The desired q-axis current in A</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;Curr_max&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot control using current mode with magnitude greater than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;I_max&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;rad/s!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">CURRENT_LOOP</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attempted to send current command without entering current control &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">comm_set_current_loop</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_output_angle_radians"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_output_angle_radians">[docs]</a>    <span class="k">def</span> <span class="nf">set_output_angle_radians</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current command to the desired position.</span>
<span class="sd">        Note, this does not send a command, it updates the TMotorManager&#39;s saved command,</span>
<span class="sd">        which will be sent when update() is called.</span>

<span class="sd">        Args:</span>
<span class="sd">            pos: The desired output angle in rad</span>
<span class="sd">            vel: The desired speed to get there (when in POSITION_VELOCITY mode)</span>
<span class="sd">            acc: The desired acceleration to get there (when in POSITION_VELOCITY mode)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;P_max&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot control using position mode for angles with magnitude greater than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;P_max&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;rad!&quot;</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad_per_Eang</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">==</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">POSITION_VELOCITY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm_set_position_velocity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_state</span> <span class="o">==</span> <span class="n">SERVO_SERIAL_CONTROL_STATE</span><span class="o">.</span><span class="n">POSITION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm_set_position</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attempted to send position command without entering position control &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">())</span> </div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_output_torque_newton_meters"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_output_torque_newton_meters">[docs]</a>    <span class="k">def</span> <span class="nf">set_output_torque_newton_meters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">torque</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current command to the desired current, based on the requested torque.</span>
<span class="sd">        Note, this does not send a command, it updates the TMotorManager&#39;s saved command,</span>
<span class="sd">        which will be sent when update() is called.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            torque: The desired output torque in Nm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_motor_current_qaxis_amps</span><span class="p">(</span> <span class="p">(</span><span class="n">torque</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;Kt&quot;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">])</span> <span class="p">)</span></div>

    <span class="c1"># motor-side functions to account for the gear ratio</span>
<div class="viewcode-block" id="TMotorManager_servo_serial.set_motor_torque_newton_meters"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_motor_torque_newton_meters">[docs]</a>    <span class="k">def</span> <span class="nf">set_motor_torque_newton_meters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">torque</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Version of set_output_torque that accounts for gear ratio to control motor-side torque</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            torque: The desired motor-side torque in Nm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output_torque_newton_meters</span><span class="p">(</span><span class="n">torque</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;Kt&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_motor_angle_radians"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_motor_angle_radians">[docs]</a>    <span class="k">def</span> <span class="nf">set_motor_angle_radians</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for set_output_angle that accounts for gear ratio to control motor-side angle</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pos: The desired motor-side position in rad.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output_angle_radians</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">])</span> <span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.set_motor_velocity_radians_per_second"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.set_motor_velocity_radians_per_second">[docs]</a>    <span class="k">def</span> <span class="nf">set_motor_velocity_radians_per_second</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for set_output_velocity that accounts for gear ratio to control motor-side velocity</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            vel: The desired motor-side velocity in rad/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_output_velocity_radians_per_second</span><span class="p">(</span><span class="n">vel</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">])</span> <span class="p">)</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_motor_angle_radians"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_motor_angle_radians">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_angle_radians</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for get_output_angle that accounts for gear ratio to get motor-side angle</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated motor-side angle in rad.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">position</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_motor_velocity_radians_per_second"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_motor_velocity_radians_per_second">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_velocity_radians_per_second</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for get_output_velocity that accounts for gear ratio to get motor-side velocity</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated motor-side velocity in rad/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">velocity</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_motor_acceleration_radians_per_second_squared"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_motor_acceleration_radians_per_second_squared">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_acceleration_radians_per_second_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for get_output_acceleration that accounts for gear ratio to get motor-side acceleration</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated motor-side acceleration in rad/s/s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">acceleration</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.get_motor_torque_newton_meters"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.get_motor_torque_newton_meters">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_torque_newton_meters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for get_output_torque that accounts for gear ratio to get motor-side torque</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The most recently updated motor-side torque in Nm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_torque_newton_meters</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s2">&quot;GEAR_RATIO&quot;</span><span class="p">]</span></div>

    <span class="c1"># Pretty stuff</span>
<div class="viewcode-block" id="TMotorManager_servo_serial.__str__"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints the motor&#39;s device info and current state&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_info_string</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; | Position: &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{: 1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_angle_radians</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; rad | Velocity: &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{: 1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_velocity_radians_per_second</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; rad/s | current: &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{: 1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">iq_current</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; A | temp: &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{: 1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_motor_state</span><span class="o">.</span><span class="n">mos_temperature</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; C&quot;</span>  <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; | Error: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_motor_error_string</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="TMotorManager_servo_serial.device_info_string"><a class="viewcode-back" href="../../TMotorCANControl.html#TMotorCANControl.servo_serial.TMotorManager_servo_serial.device_info_string">[docs]</a>    <span class="k">def</span> <span class="nf">device_info_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints the motor&#39;s serial port and device type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_params</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Port: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span></div>

    <span class="c1"># controller variables</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_temperature_celsius</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;temperature_degrees_C&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Temperature in Degrees Celsius&quot;&quot;&quot;</span>

    <span class="c1"># TODO write actual codes in description here as well</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_motor_error_code</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Error Codes:</span>
<span class="sd">            0  : &#39;FAULT_CODE_NONE&#39;</span>
<span class="sd">            1  : &#39;FAULT_CODE_OVER_VOLTAGE&#39;</span>
<span class="sd">            2  : &#39;FAULT_CODE_UNDER_VOLTAGE&#39;</span>
<span class="sd">            3  : &#39;FAULT_CODE_DRIVE&#39;</span>
<span class="sd">            4  : &#39;FAULT_CODE_ABS_OVER_CURRENT&#39;</span>
<span class="sd">            5  : &#39;FAULT_CODE_OVER_TEMP_FET&#39;</span>
<span class="sd">            6  : &#39;FAULT_CODE_OVER_TEMP_MOTOR&#39;</span>
<span class="sd">            7  : &#39;FAULT_CODE_GATE_DRIVER_OVER_VOLTAGE&#39;</span>
<span class="sd">            8  : &#39;FAULT_CODE_GATE_DRIVER_UNDER_VOLTAGE&#39;</span>
<span class="sd">            9  : &#39;FAULT_CODE_MCU_UNDER_VOLTAGE&#39;</span>
<span class="sd">            10 : &#39;FAULT_CODE_BOOTING_FROM_WATCHDOG_RESET&#39;</span>
<span class="sd">            11 : &#39;FAULT_CODE_ENCODER_SPI&#39;</span>
<span class="sd">            12 : &#39;FAULT_CODE_ENCODER_SINCOS_BELOW_MIN_AMPLITUDE&#39;</span>
<span class="sd">            13 : &#39;FAULT_CODE_ENCODER_SINCOS_ABOVE_MAX_AMPLITUDE&#39;</span>
<span class="sd">            14 : &#39;FAULT_CODE_FLASH_CORRUPTION&#39;</span>
<span class="sd">            15 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_1&#39;</span>
<span class="sd">            16 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_2&#39;</span>
<span class="sd">            17 : &#39;FAULT_CODE_HIGH_OFFSET_CURRENT_SENSOR_3&#39;</span>
<span class="sd">            18 : &#39;FAULT_CODE_UNBALANCED_CURRENTS&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># electrical variables</span>
    <span class="n">current_qaxis</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_current_qaxis_amps</span><span class="p">,</span> <span class="n">set_motor_current_qaxis_amps</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;current_qaxis_amps&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Q-axis current in amps&quot;&quot;&quot;</span>

    <span class="n">current_daxis</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_current_daxis_amps</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;current_daxis_amps&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;D-axis current in amps&quot;&quot;&quot;</span>

    <span class="n">current_bus</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_current_bus_amps</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;current_bus_amps&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Bus input current in amps&quot;&quot;&quot;</span>

    <span class="n">voltage_qaxis</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_voltage_qaxis_volts</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;voltage_qaxis_volts&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Q-axis voltage in volts&quot;&quot;&quot;</span>

    <span class="n">voltage_daxis</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_voltage_daxis_volts</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;voltage_daxis_volts&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;D-axis voltage in volts&quot;&quot;&quot;</span>

    <span class="n">voltage_bus</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_voltage_bus_volts</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;voltage_bus_volts&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Bus input voltage in volts&quot;&quot;&quot;</span>

    <span class="c1"># output-side variables</span>
    <span class="n">position</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_output_angle_radians</span><span class="p">,</span> <span class="n">set_output_angle_radians</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;output_angle_radians&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Output angle in rad&quot;&quot;&quot;</span>

    <span class="n">velocity</span> <span class="o">=</span> <span class="nb">property</span> <span class="p">(</span><span class="n">get_output_velocity_radians_per_second</span><span class="p">,</span> <span class="n">set_output_velocity_radians_per_second</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;output_velocity_radians_per_second&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Output velocity in rad/s&quot;&quot;&quot;</span>

    <span class="n">acceleration</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_output_acceleration_radians_per_second_squared</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;output_acceleration_radians_per_second_squared&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Output acceleration in rad/s/s&quot;&quot;&quot;</span>

    <span class="n">torque</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_output_torque_newton_meters</span><span class="p">,</span> <span class="n">set_output_torque_newton_meters</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;output_torque_newton_meters&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Output torque in Nm&quot;&quot;&quot;</span>

    <span class="c1"># motor-side variables</span>
    <span class="n">angle_motorside</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_motor_angle_radians</span><span class="p">,</span> <span class="n">set_motor_angle_radians</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;motor_angle_radians&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Motor-side angle in rad&quot;&quot;&quot;</span>
    
    <span class="n">velocity_motorside</span> <span class="o">=</span> <span class="nb">property</span> <span class="p">(</span><span class="n">get_motor_velocity_radians_per_second</span><span class="p">,</span> <span class="n">set_motor_velocity_radians_per_second</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;motor_velocity_radians_per_second&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Motor-side velocity in rad/s&quot;&quot;&quot;</span>

    <span class="n">acceleration_motorside</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_motor_acceleration_radians_per_second_squared</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;motor_acceleration_radians_per_second_squared&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Motor-side acceleration in rad/s/s&quot;&quot;&quot;</span>

    <span class="n">torque_motorside</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_motor_torque_newton_meters</span><span class="p">,</span> <span class="n">set_motor_torque_newton_meters</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;motor_torque_newton_meters&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Motor-side torque in Nm&quot;&quot;&quot;</span></div>


    














</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Mitry Anderson, Vamsi Peddinti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>